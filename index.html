<!DOCUMENTTYPE html>
<html>
<head>
	<title>千秋戏</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="height=device-height,
                      width=device-width, initial-scale=1.0,
                      minimum-scale=1.0, maximum-scale=1.0,
                      user-scalable=no">
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico"/>
	<link rel="stylesheet" type="text/css" href="segmented-controls.css">
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" type="text/css" href="decks.css">
	<link rel="stylesheet" type="text/css" href="notifications.css">
	<link rel="stylesheet" type="text/css" href="tableinfo.css">
</head>

<body>
	<div id="configurator" class="flexbox">
		<div id="modeinput" class="segmented-control" style="width: 100%; color: #334422">
			<input type="radio" name="gamemode" id="vs_ai"     checked onclick='SetGameMode(1);'>
			<input type="radio" name="gamemode" id="vs_player" onclick='SetGameMode(2);'>
			<label for="vs_ai"     data-value="独享的快乐">单人游戏</label>
			<label for="vs_player" data-value="双倍的快乐">双人对战</label>
	  </div>
		<div id="packinput" class="segmented-control" style="width: 100%; color: #281B11">
			<input type="radio" name="version" id="p12" checked>
			<input type="radio" name="version" id="p13" disabled="true">
			<input type="radio" name="version" id="p23" disabled="true">
			<label for="p12" data-value="1+2 代人物">1+2</label>
			<label for="p13" data-value="1+3 代人物">1+3</label>
			<label for="p23" data-value="2+3 代人物">2+3</label>
		</div>
		<div id="voiceinput" class="segmented-control" style="width: 100%; color: #281B11">
			<input type="radio" name="voice" id="voiceon" checked>
			<input type="radio" name="voice" id="voiceoff">
			<label for="voiceon" data-value="完成组合时播放语音">语音</label>
			<label for="voiceoff" data-value="完成组合时BlueBlue">无语音</label>
		</div>
	  <div id="multiplayerinputs" style="width:100%">
      <!--<div id="prestrictioninput" class="segmented-control" style="width: 50%;
      color: #281B11">
         <input type="radio" name="prestriction" id="prestriction1" checked>
         <input type="radio" name="prestriction" id="prestriction2">
         <label for="prestriction1" data-value="不限制牌组">不限制牌组</label>
         <label for="prestriction2" data-value="必须使用所选牌组">限制牌组</label>
      </div>
      -->
      <div id="multiplayerinfo" style="width:100%; color:#112211">
        <div style="width: 100%;">
          <div id="lobbystatus">
          当前在线人数：未知
          </div>
          <div id="myplayerid">
          （ID）
          </div>
          <div id="refresh_lobbystatus">
          [刷新]
          </div>
        </div>
      </div>
      <div id="multiplayertypeinput" class="segmented-control" style="width: 50%;
      color: #281B11">
         <input type="radio" name="multiplayertype" id="multiplayertype1" checked>
         <input type="radio" name="multiplayertype" id="multiplayertype2">
         <label for="multiplayertype1" data-value="选人一起玩">选人一起玩</label>
         <label for="multiplayertype2" data-value="随机匹配小伙伴">随机匹配小伙伴</label>
      </div>
      <div id="room_buttons" style="width: 100%; margin-bottom: 0.5vw; margin-top: 0.5vw">
        <div id="inviteinput" class="inviteinput" style="width:35%">
        对方ID：<input id="invitedid" type="text" size=5></input>
        </div>
        <div id="invitebutton">
        邀请之
        </div>
      </div>
      <div id="match_buttons" style="width: 100%; margin-bottom: 0.5vw; margin-top: 0.5vw">
        <div id="start_match" style="">随机寻找对手</div>
      </div>
      <div id="confirm_cancel_buttons" style="width:100%; margin-bottom: 0.5vw; margin-top: 0.5vw"> 
        <div id="confirm_match" style="display:none">确认配对</div>
        <div id="cancel_match" style="display:none">放弃配对</div>
      </div>
    </div>
    <div id="singleplayerinputs" style="width:100%">
      <div id="aiinput" class="segmented-control" style="width: 100%; color: #281B11">
		<input type="radio" name="ai" id="ai1">
		<input type="radio" name="ai" id="ai2" checked>
		<input type="radio" name="ai" id="ai3" >
		<label for="ai1" data-value="温和亲切的AI">炤级</label>
		<label for="ai2" data-value="沉迷种田的AI">洛级</label>
		<label for="ai3" data-value="恶意满满的AI">危级</label>
	</div>
	<div id="spinput" class="segmented-control" style="width: 100%; color: #281B11">
		<input type="radio" name="sp" id="sp0">
		<input type="radio" name="sp" id="sp1" checked>
		<label for="sp0" data-value="你和AI都不想使用珍稀牌">不含珍稀牌</label>
		<label for="sp1" data-value="可使用所有珍稀牌 [测试中]">包含珍稀牌</label>
	</div>
		<div id="gamestart">开始游戏</div>
    </div>
	<div id="spselection">
		<div id="p0sp"></div>
		<div id="sprepo"></div>
		<div id="p1sp"></div>
	</div>
	</div>
	<div id="spselection">
		<div id="p0sp"></div>
		<div id="sprepo"></div>
		<div id="p1sp"></div>
	</div>
	<div id="main">
		<div id="scoreboard">
			<div id="table0" class="cardstack"></div>
			<div id="score0" class="bignotice">
				<div></div>
				<div class="combobonus">
				</div>
			</div>
			<div id="infobox" class="bignotice"><div></div></div>
			<div id="score1" class="bignotice">
				<div></div>
				<div class="combobonus"></div>
			</div>
			<div id="table1" class="cardstack"></div>
		</div>
		<div id="gamezonecontainer">
			<div id="gamezone">
				<div id="hand0container"><div id="hand0"></div></div>
				<div id="poolcontainer">
					<div id="pool"></div>
					<div id="repository"></div>
				</div>
				<div id="hand1container"><div id="hand1"></div>
				  <div id="infobox1"></div>
				  <div id="BOOM" onclick="autotest()">BOOM</div>
				</div>
				<div id="blocker" class="cover"></div>
				<div id="finalcontainer" class="cover">
					<div></div><div></div><div></div>
					<div>
						<div id="finalmsg" class="bignotice">你赢了</div>
						<p>点击牌桌区域继续</p>
					</div>
					<p class="string"></p>
				</div>
				<div class="tableinfocontainer cover transitopacity">
					<div class="charinfocontainer flexbox"></div>
					<div class="charinfocontainer flexbox"></div>
				</div>
			</div>
			<div class="tableinfocontainer cover transitopacity">
				<div class="infoheader bignotice">
						<div>&#9830; 对方卡牌</div>
						<div>&#9830; 完成组合</div>
						<div>&#9830; 未完组合</div>
					</ul>
				</div>
				<div class="charinfocontainer flexbox"></div>
				<div class="ccomboinfocontainer flexbox"></div>
				<div class="icomboinfocontainer flexbox"></div>
			</div>
			<div class="tableinfocontainer cover transitopacity">
				<div class="infoheader bignotice">
						<div>&#9830; 我方卡牌</div>
						<div>&#9830; 完成组合</div>
						<div>&#9830; 未完组合</div>
					</ul>
				</div>
				<div class="charinfocontainer flexbox"></div>
				<div class="ccomboinfocontainer flexbox"><!--
					<div class="combocard">
						<div>
							<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
						</div>
						<div>
							<div id="combocardinfo">
								<div>老板</div>
								<div>90</div>
							</div>
							<div id="combocardchars">
								<span class="ismine">欧阳少恭</span><span class="notmine">沈夜</span>
							</div>
						</div>
					</div>-->
				</div>
				<div class="icomboinfocontainer flexbox"></div>
			</div>
			<div class="tableinfocontainer cover transitopacity">
				<div class="infoheader bignotice">
						<div>&#9830; 我方珍稀牌</div>
				</div>
				<div class="charinfocontainer specials flexbox"></div>
			</div>
		</div>
		<div id="specialboard">
			<div id="specials0" class="cardstack"></div>
			<div id="hoverinfobox" class="bignotice"><div></div></div>
			<div id="specials1" class="cardstack"></div>
		</div>
	</div>
	<div id="infobanner" class="cover transitopacity banner">
		<div>
			<div class="bannertext">
				<span></span><span class="bannerhl"></span><span></span><span class="bannerhl"></span><span></span>
			</div>
			<div class="bannercards"><!--
				<div class="swapposter">
				<div></div>
					<div class="postercard"></div>
				</div>
				<div class="swapposter">
					<div></div>
					<div class="postercard" style="background-image:url(img/wz3.jpg)"></div>
				</div>-->
			</div>
		</div>
	</div>
	<audio id="soundeffect" src=""></audio>
</body>
</html>
<script src="tricks.js"></script>
<script src="model.js"></script>
<script src="controller.js"></script>
<script src="spmanager.js"></script>
<script src="tableinfoview.js"></script>
<script src="view.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
  var is_my_move = false;
  var g_my_player_id = -999;
  
  // 按键事件
  document.getElementById("refresh_lobbystatus").addEventListener("click", function() {
    socket.emit('Info_RefreshOnlinePlayerCount');
  });
  document.getElementById("cancel_match").addEventListener("click", function(){
    socket.emit('Match_CancelMatch');
    lobbystatus.textContent = "你取消了匹配";
    document.getElementById("start_match").style.display = "inline-block";
    document.getElementById("confirm_match").style.display = "none";
    document.getElementById("cancel_match").style.display = "none";
  });
  document.getElementById("multiplayertype1").addEventListener("click", function(){
    SetMultiplayerMode(1);
  });
  document.getElementById("multiplayertype2").addEventListener("click", function(){
    SetMultiplayerMode(2);
  });
  
  function SetGameMode(m) {
    if (m == 1) { // 单人模式
      document.getElementById("multiplayerinputs").style.display="none";
      document.getElementById("singleplayerinputs").style.display="block";
    } else { // 对战模式
      document.getElementById("multiplayerinputs").style.display="block";
      document.getElementById("singleplayerinputs").style.display="none";
      
      document.getElementById("start_match").style.display = "inline-block";
      document.getElementById("confirm_match").style.display = "none";
      document.getElementById("cancel_match").style.display = "none";
    }
  }
  function SetMultiplayerMode(m) {
    ShowMultiplayerStep2();
  }
  
  // 多人的Step1:选择是邀请指定玩家还是随机寻找对手
  
  // 多人的Step2：如果是邀请 就需要输入对方ID
  //            如果是随机 就要按一下”随机寻找对手“
  function ShowMultiplayerStep2() {
    if (document.getElementById('multiplayertype1').checked == true) { // 邀
      document.getElementById("room_buttons").style.display = "block";
      document.getElementById("match_buttons").style.display = "none";
    } else if (document.getElementById('multiplayertype2').checked == true) {
      document.getElementById("room_buttons").style.display = "none";
      document.getElementById("match_buttons").style.display = "block";
    }
  }
  
  function HideMultiplayerStep2() {
    document.getElementById("room_buttons").style.display = "none";
    document.getElementById("match_buttons").style.display = "none";
  }
  
  function ShowMultiplayerStep3() {
    document.getElementById('match_buttons').style.display = "block";
  }
  
  function HideMultiplayerStep3() {
    document.getElementById('match_buttons').style.display = "none";
  }
  
  // 开始匹配或开始等人时就不能改设置了
  function FixMultiplayerRoomSettings() {
    document.getElementById('prestriction1').disabled = true;
    document.getElementById('prestriction2').disabled = true;
  }
  function UnfixMultiplayerRoomSettings() {
    document.getElementById('prestriction1').disabled = false;
    document.getElementById('prestriction2').disabled = false;
  }
  
  // 邀请指定玩家
  // 如果邀请成功就当作匹配成功来处理...
  document.getElementById("invitebutton").addEventListener("click", function(){
    var invited_id = document.getElementById("invitedid").value;
    console.log('Invite ' + invited_id);
    socket.emit('Match_InvitePlayer', invited_id);
  });
  
  // 开始匹配
  document.getElementById("start_match").addEventListener("click", function() {
    socket.emit('Match_ReadyToMatch');
  });
  document.getElementById("confirm_match").addEventListener("click", function() {
    socket.emit('Match_ConfirmMatch');
  });
  // 来自服务器的消息
  var lobbystatus = document.getElementById("lobbystatus");
  socket = io.connect();
  socket.on('Info_OnlinePlayerCount', function(n) {
    lobbystatus.innerHTML = "当前人数："+n;
  });
  socket.on('Info_MyPlayerId', function(pid) {
    g_my_player_id = pid;
    document.getElementById('myplayerid').textContent = 'ID: ' + pid;
  });
  socket.on('Match_ReadyToMatchAck', function() {
    document.getElementById("start_match").style.display = "none";
    document.getElementById("confirm_match").style.display = "none";
    document.getElementById("cancel_match").style.display = "inline-block";
    lobbystatus.innerHTML = "正在寻找同伴中";
  });
  socket.on('Match_FoundMatch', function(reason) {
    // 邀请模式下，如果找到了被邀请的人，也走这里
    HideMultiplayerStep2();
    ShowMultiplayerStep3();
    
    document.getElementById("start_match").style.display = "none";
    document.getElementById("confirm_match").style.display = "inline-block";
    document.getElementById("cancel_match").style.display = "inline-block";
    lobbystatus.innerHTML = reason;
  });
  socket.on('Match_ConfirmMatchAck', function(msg) {
    lobbystatus.innerHTML = msg;
  });
  socket.on('Match_OtherPlayerConfirmed', function() {
    lobbystatus.innerHTML = "对方玩家已确认";
  });

  var AUTOTEST = true;
  socket.on('Match_GameStartOffensive', () => { // 先手开局 
    gameinit(true);
    socket.emit('Match_GameStartOffensiveAck',
      model.player0.hand.characters,
      model.player1.hand.characters,
      model.pool.characters,
      model.commonRepository.characters);
  });
  
  socket.on('Match_GameStartDefensive', (p0c, p1c, poolc, repoc) => { // 后手开局
    console.log('[后手开局]');
    gameinit(true, 1, p0c, p1c, poolc, repoc);
  });
  
  socket.on('Room_PlayerDisconnected', () => {
    console.log('对方玩家已离线');
  });
  
  socket.on('Match_OtherPlayerCancelsMatch', () => {
    HideMultiplayerStep3();
    ShowMultiplayerStep2();
    document.getElementById('lobbystatus').textContent = '对方取消了匹配';
    document.getElementById("start_match").style.display = "inline-block";
    document.getElementById("confirm_match").style.display = "none";
    document.getElementById("cancel_match").style.display = "none";
  });
  
  socket.on('Match_InvalidInvitation', (reason) => {
    lobbystatus.textContent = reason;
    console.log('邀请不成功' + reason);
  });
  
  // https://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // StressTesting
  async function ScanMyHand() {
    console.log("ScanMyHand()");
    var cc = model.player1.hand.characters;
    var h_cand = undefined, p_cand = undefined, h_cand_idx = -999;
    var done = false;
    if (!is_my_move) return;
    
    for (var i=0; i<cc.length; i++) {
      var c = cc[i];
      if (c.card.card.classList.contains("glow")) {
        c.card.card.click();
        await sleep(233);
      }
    }
    
    for (var i=0; i<cc.length; i++) {
      var c = cc[i];
      
      if (!is_my_move) return;
      await sleep(233);
      c.card.card.click();
      await sleep(233);
      var pc = model.pool.characters;
      for (var j=0; j<pc.length; j++) {
        if (pc[j].card.card.classList.contains("glow")) {
          if (h_cand == undefined) {
            h_cand = c;
            p_cand = pc[j];
            if (!is_my_move) return;
            await sleep(233);
            p_cand.card.card.click();
            done = true;
            break;
          }
        }
      }
      if(done) {
        break;
      } else {
        if (c.card.card.classList.contains("glow")) {
          c.card.card.click();
        }
        await sleep(233);
      }
    }
    
    console.log(h_cand)
    console.log(p_cand)
    
    if (done) {
    } else if(false) { // 置换？
      
      if (h_cand != undefined && p_cand != undefined) {
        h_cand.card.card.click();
        p_cand.card.card.click();
        await sleep(700);
      } else {
        
        var card1 = model.player1.hand.characters[0];
        await sleep(300);
        card1.card.card.click();
        await sleep(300);
      }
    }
  }
  var is_autotesting = false;
  async function autotest() {
    if (is_autotesting) return;
    else is_autotesting = true;
    if (document.getElementById('finalcontainer').style.display == "block")
      await sleep(2666); // 等游戏结束通知消失
    while (true) {
      await sleep(1000);
      if (is_my_move) {
        if (document.getElementsByClassName('tableinfocontainer')[1].style.display == "block") {
          await sleep(200);
          model.player1.table.characters[0].card.card.click();
          await sleep(200);
        }
        if (document.getElementById('combobanner').style.display == "block") {
          await sleep(100);
          continue;
        } else if (document.getElementById('finalcontainer').style.display == "block") {
          await sleep(2666); // 等游戏结束通知消失
          document.getElementById('finalcontainer').click();
        } else {
          await sleep(300);
          await ScanMyHand();
        }
      }
    }
  }
  
  var AutoStartAutoTest = false;
  async function autostart() {
    while (true) {
      await sleep(1000);
      var x = document.getElementById('start_match'); 
      if (x.style.visibility == '') {
        x.click();
        console.log("Start clicked");
        while (true) {
          await sleep(1000);
          var y = document.getElementById('confirm_match');
          if (y.style.display != 'none') {
            y.click();
            console.log("Confirm clicked");
            return;
          }
        }
      }
    }
  }
  
  if (AutoStartAutoTest) {
    autostart();
  }
  
  // 默认打开多人模式
  document.getElementById('vs_player').click();
  document.getElementById('multiplayertype2').click();
  
</script>
