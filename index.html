<!DOCUMENTTYPE html>
<html>
<head>
	<title>千秋戏</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="segmented-controls.css">
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" type="text/css" href="decks.css">
	<link rel="stylesheet" type="text/css" href="notifications.css">
	<link rel="stylesheet" type="text/css" href="tableinfo.css">
</head>

<body>
	<div id="configurator" class="flexbox">
		<div id="packinput" class="segmented-control" style="width: 100%; color: #281B11">
			<input type="radio" name="version" id="p12" checked>
			<input type="radio" name="version" id="p13" disabled="true">
			<input type="radio" name="version" id="p23" disabled="true">
			<label for="p12" data-value="1+2 代人物">1+2</label>
			<label for="p13" data-value="1+3 代人物">1+3</label>
			<label for="p23" data-value="2+3 代人物">2+3</label>
		</div>
		<div id="modeinput" class="segmented-control" style="width: 100%; color: #334422">
			<input type="radio" name="gamemode" id="vs_ai"     checked onclick="ShowAIInput();">
			<input type="radio" name="gamemode" id="vs_player" onclick="HideAIInput();">
			<label for="vs_ai"     data-value="独享的快乐">单人游戏</label>
			<label for="vs_player" data-value="双倍的快乐">双人对战</label>
		</div>
		<div id="aiinput" class="segmented-control" style="width: 100%; color: #281B11">
			<input type="radio" name="ai" id="ai1" checked>
			<input type="radio" name="ai" id="ai2" >
			<input type="radio" name="ai" id="ai3" >
			<label for="ai1" data-value="十分智障的AI">AI 一级</label>
			<label for="ai2" data-value="沉迷种田的AI">AI 二级</label>
			<label for="ai3" data-value="恶意满满的AI">AI 三级</label>
		</div>
		<div class="segmented-control" style="width: 100%;">
			<div id="lobbystatus">
			当前在线人数：未知
			</div>
		</div>
		<div id="match_buttons" style="width: 100%">
			<div id="start_match" style="">开始匹配</div>
			<div id="confirm_match" style="display:none">确认匹配</div>
			<div id="cancel_match" style="display:none">放弃匹配</div>
		</div>
		<div id="gamestart">开始游戏</div>
	</div>
	<div id="main">
		<div id="scoreboard">
			<div id="table0"></div>
			<div id="score0" class="bignotice"></div>
			<div id="score1" class="bignotice"></div>
			<div id="table1"></div>
		</div>
			<div id="gamezone">
				<div id="hand0container"><div id="hand0"></div></div>
				<div id="poolcontainer">
					<div id="pool"></div>
					<div id="repository"></div>
				</div>
				<div id="hand1container"><div id="hand1"></div><div id="infobox1"></div></div>
				<div id="blocker" class="cover"></div>
				<div id="finalcontainer" class="cover">
					<div></div><div></div><div></div>
					<div>
						<div id="finalmsg" class="bignotice">你赢了</div>
						<p>点击牌桌区域继续</p>
					</div>
					<p class="string"></p>
				</div>
				<div class="tableinfocontainer cover">
					<div class="infoheader flexbox">
							<div>&#9830; 卡牌</div>
							<div>&#9830; 完成组合</div>
							<div>&#9830; 未完组合</div>
						</ul>
					</div>
					<div class="charinfocontainer flexbox" ></div>
					<div class="ccomboinfocontainer flexbox"></div>
					<div class="icomboinfocontainer flexbox" ></div>
				</div>
				<div class="tableinfocontainer cover">
					<div class="infoheader flexbox">
							<div>&#9830; 卡牌</div>
							<div>&#9830; 完成组合</div>
							<div>&#9830; 未完组合</div>
						</ul>
					</div>
					<div class="charinfocontainer flexbox" ></div>
					<div class="ccomboinfocontainer flexbox"><!--
						<div class="combocard">
							<div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
								<div class="thumbnailcard" style="background-Image:url('img/oysg1.jpg')"></div>
							</div>
							<div>
								<div id="combocardinfo">
									<div>老板</div>
									<div>90</div>
								</div>
								<div id="combocardchars">
									<span class="ismine">巫炤</span><span class="ismine">欧阳少恭</span><span class="notmine">沈夜</span><span class="ismine">巫炤</span>
								</div>
							</div>
						</div>-->
					</div>
					<div class="icomboinfocontainer flexbox" ></div>
				</div>
			</div>
			<div id="specialboard">
				<p></p>
				<div id="infobox"></div>
			</div>
	</div>
	<div id="combobanner" class="cover transitopacity banner">
		<div id="combotext">完成组合<span class="combohl"></span>，获得<span class="combohl"></span>分</div>
		<div id="combocards">
			<div class="postercard"></div>
			<div class="postercard"></div>
			<div class="postercard"></div>
			<div class="postercard"></div>
			<div class="postercard"></div>
			<div class="postercard"></div>
		</div>
	</div>
</body>
</html>
<script src="model.js"></script>
<script src="controller.js"></script>
<script src="tableinfoview.js"></script>
<script src="view.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
  // 按键事件
  function ShowAIInput() {
    document.getElementById("aiinput").style.display="inline-block";
    document.getElementById("gamestart").style.display="inline-block";
    document.getElementById("lobbystatus").style.display="none";
    document.getElementById("match_buttons").style.display="none";
  }
  function HideAIInput() {
    document.getElementById("aiinput").style.display="none";
    document.getElementById("gamestart").style.display="none";
    document.getElementById("lobbystatus").style.display="inline-block";
    document.getElementById("match_buttons").style.display="inline-block";
  }
  // 开始匹配
  document.getElementById("start_match").addEventListener("click", function() {
    socket.emit('Match_ReadyToMatch');
  });
  document.getElementById("confirm_match").addEventListener("click", function() {
    socket.emit('Match_ConfirmMatch');
  });
  // 来自服务器的消息
  var lobby_status = document.getElementById("lobbystatus");
  socket = io.connect();
  socket.on('Info_OnlinePlayerCount', function(n) {
    lobby_status.innerHTML = "当前人数："+n;
  });
  socket.on('Match_ReadyToMatchAck', function() {
    document.getElementById("start_match").style.display = "none";
    document.getElementById("confirm_match").style.display = "none";
    document.getElementById("cancel_match").style.display = "inline-block";
    lobby_status.innerHTML = "正在寻找同伴中";
  });
  socket.on('Match_FoundMatch', function() {
    document.getElementById("start_match").style.display = "none";
    document.getElementById("confirm_match").style.display = "inline-block";
    document.getElementById("cancel_match").style.display = "inline-block";
    lobby_status.innerHTML = "已找到同伴，请确认";
  });
  socket.on('Match_ConfirmMatchAck', function(msg) {
    lobby_status.innerHTML = msg;
  });
  socket.on('Match_OtherPlayerConfirmed', function() {
    lobby_status.innerHTML = "对方玩家已确认";
  });

  socket.on('Match_GameStart', function(player_self, player_oppo, pool, pack) {
    console.log("player_self:");
    console.log(player_self)
    console.log("player_oppo:");
    console.log(player_oppo)
    console.log(pack)
    // Client's 'gameinit'
    document.getElementById("main").style.display = "block";
    document.getElementById("configurator").style.display = "none";
    sound = new Sound();
    combos = new Combos();
    controller = new Controller();
    messenger = new Messenger();
    
    // Client-side 'model.init()'
    // replicate the behavior of initHand here
    
    model = new Model(pack[0], pack[1]);
    model.isMultiplayer = true;
    view = new View();
    oppoinfo = new TableInfoView(model.player0);
    playerinfo = new TableInfoView(model.player1);
    
    // Inside original model.init()
    view.init();
    //model.initHand(model.player0);
    model.initHandByRemoteState(model.player0, player_oppo);
    //model.initHand(model.player1);
    model.initHandByRemoteState(model.player1, player_self);
    //model.initPool();
    model.initPoolByRemoteState(model.pool,    pool);
    
    view.hand0.init();
    view.hand1.init();
    view.pool.init();
    
    console.log("Player 0:")
    console.log(model.player0)
    console.log("Player 1:")
    console.log(model.player1)
  });
  
  socket.on('Game_MakeTurn', () => {
    controller.onMyTurn();
    messenger.notifyMyTurn();
  });
  
  socket.on('Game_OpponentTurn', () => {
    controller.onOpponentTurn();
    messenger.notifyOpponentTurn();
  });
  
  socket.on('Game_OpponentObtainPair', (handc_id, poolc_id) => {
    console.log('OpponentObtainPair ' + handc_id + " " + poolc_id);
    controller.opponentObtainMultiplayer(handc_id, poolc_id);
  });
  
  socket.on('Game_DealOne', (dealt_cid) => {
    model.dealOne(dealt_cid); 
  });
  
  socket.on('Game_OppoDiscard', (char_id, newchar_id) => {
    model.oppoDiscard_client(char_id, newchar_id); 
  });
  
  socket.on('Game_OppoRedeal', (pool_cids) => {
    model.oppoRedeal(pool_cids);
  });
</script>
