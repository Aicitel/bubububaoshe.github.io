COMMONCHARLIST = [

  ["ly1", "陵越", 2, "冬"],
  ["qy1", "悭臾", 2, "夏"],
  ["fqx1", "风晴雪", 2, "春"],
  ["tyc1", "天墉城", 2, "夏"],
  ["hllp1", "黑龙鳞片", 2, "夏"],
  ["gjfj1", "古剑焚寂", 2, "夏"],
  ["zll1", "紫榕林", 2, "秋"],
  ["xf1", "巽芳", 2, "春"],
  ["gjhy1", "古剑红玉", 2, "夏"],
  ["qysnp1", "青玉司南佩", 2, "春"],
  ["xl1", "襄铃", 2, "夏"],

  ["sy2", "沈夜", 2, "冬"],
  ["sx2", "沈曦", 2, "春"],
  ["lyc2", "流月城", 2, "冬"],
  ["xyz2", "夏夷则", 2, "冬"],
  ["ths2", "太华山", 2, "冬"],
  ["hy2", "华月", 2, "冬"],
  ["zm2", "昭明", 2, "春"],
  ["ar2", "阿阮", 2, "春"],
  ["yq2", "禺期", 2, "夏"],
  ["ywy2", "乐无异", 2, "夏"],
  ["wc2", "忘川", 2, "冬"],
  ["lc2", "露草", 2, "春"],
  ["qhzr2", "清和真人", 2, "秋"],
  ["wmzj2", "无名之剑", 2, "秋"],
  ["ca2", "长安", 2, "春"],
  ["gjhg2", "古剑晗光", 2, "冬"],
  ["jql2", "金麒麟", 2, "秋"],
  ["ttzq2", "通天之器", 2, "秋"],
  ["ws2", "巫山", 2, "夏"],
  ["wry2", "闻人羽", 2, "秋"],

  ["sw3", "司危", 2, "春"],
  ["bl3", "北洛", 2, "春"],
  ["ywy3", "云无月", 2, "冬"],
  ["cy3", "岑婴", 2, "夏"],
  ["xg3", "玄戈", 2, "秋"],
  ["ns3", "霓商", 2, "夏"],
  ["jxy3", "姬轩辕", 2, "秋"],
  ["jy3", "缙云", 2, "夏"],
  ["bhl3", "半魂莲", 2, "秋"],
  ["tl3", "天鹿", 2, "秋"],
  ["wz3", "巫炤", 2, "冬"],
  ["ts3", "太岁", 2, "春"],
  ["sz3", "蜃珠", 2, "夏"],
  ["wmzd3", "无名之地", 2, "冬"],
  ["tlc3", "天鹿城", 2, "秋"],
  ["wzg3", "巫之国", 2, "冬"],
  ["xl3", "西陵", 2, "春"],
  ["lz3", "嫘祖", 2, "夏"],
  ["fls3", "风里沙", 2, "秋"],
  ["lxj3", "凌星见", 2, "春"]
];

COMBOLIST = [
  [ [ "风晴雪", "焦炭", "谢衣" ], "厨房功夫", 10],
  [ [ "谢衣", "乐无异"], "春风雨", 4],
  [ [ "谢衣", "静水湖"], "重山隐", 4] ,
  [ [ "谢衣", "沈夜"], "孤月寒灯", 4] ,
  [ [ "谢衣", "忘川"], "别破军", 4] ,
  [ [ "谢衣", "通天之器"], "空留忆", 4] ,
  [ [ "流月城", "谢衣"], "胡不归", 4] ,
  [ [ "流月城", "沈夜"], "永夜寒沉", 4] ,
  [ [ "沈曦", "沈夜"], "三日遥", 4] ,
  [ [ "流月城", "沈曦"], "月中生", 4] ,
  [ [ "兔子抱枕", "沈曦"], "伴长眠", 4] ,
  [ [ "华月的箜篌", "华月"], "廉贞曲", 4] ,
  [ [ "流月城", "华月"], "月之殇", 4] ,
  [ [ "华月", "沈夜"], "护孤城", 4] ,
  [ [ "谢衣", "沈夜", "沈曦", "华月"], "烈山遗族", 20] ,
  [ [ "谢衣", "沈夜", "沈曦", "流月城", "华月"], "红月", 40] ,
  [ ["古剑晗光", "乐无异"], "家传宝贝", 5],
  [ ["禺期", "古剑晗光", "乐无异"], "剑主之谊", 10],
  [ ["长安", "乐无异"], "玉京游", 4],
  [ ["闻人羽", "乐无异"], "比肩行", 5],
  [ ["金麒麟", "闻人羽", "乐无异"], "长相忆", 10],
  [ ["百草谷", "闻人羽"], "星海天罡", 5],
  [ ["夏夷则", "太华山"], "逸尘", 5],
  [ ["夏夷则", "露草"], "待佳期", 4],
  [ ["太华山", "清和真人"], "太华山人", 4],
  [ ["夏夷则", "清和真人"], "严师胜父", 4],
  [ ["夏夷则", "阿阮"], "光逐影", 5],
  [ ["夏夷则", "太华山", "清和真人"], "温茶相待", 10],
  [ ["露草", "阿阮"], "共株生", 4],
  [ ["昭明", "阿阮"], "芳草心", 4],
  [ ["巫山", "阿阮"], "山鬼", 5],
  [ ["神女墓", "巫山"], "神女静眠", 4],
  [ ["巫山", "露草", "阿阮"], "露草流萤", 10],
  [ ["巫山", "露草", "阿阮", "神女墓"], "巫山神女", 20],
  [ ["禺期", "红玉"], "古剑剑灵", 4],
  [ ["禺期", "昭明"], "铸剑仙师", 4],
  [ ["禺期", "无名之剑"], "历劫重生", 4],
  [ ["禺期", "古剑晗光"], "未成之剑", 4],
  [ ["昭明", "无名之剑", "古剑晗光"], "千年一器", 10],
  [ ["昭明", "无名之剑", "古剑晗光", "禺期"], "天地熔炉", 20],
  [ ["昭明", "无名之剑", "古剑焚寂", "古剑红玉", "古剑晗光"], "古剑奇谭", 40],
  [ ["夏夷则", "阿阮", "闻人羽", "乐无异"], "蓝衫偃师记", 20],
  [ ["欧阳少恭", "青玉坛"], "丹芷长老", 4],
  [ ["欧阳少恭", "凤来"], "揽琴独照", 4],
  [ ["巽芳", "欧阳少恭"], "仙山眷侣", 4],
  [ ["榣山", "欧阳少恭"], "故地重回", 4],
  [ ["悭臾", "欧阳少恭"], "榣山遗韵", 4],
  [ ["欧阳少恭", "蓬莱"], "栖身之所", 4],
  [ ["巽芳", "蓬莱"], "蓬莱公主", 4],
  [ ["巽芳", "蓬莱", "欧阳少恭"], "芳华如梦", 10],
  [ ["黑龙鳞片", "悭臾"], "应龙信物", 4],
  [ ["榣山", "悭臾"], "水虺醉琴", 4],
  [ ["欧阳少恭", "方兰生"], "琴川友", 4],
  [ ["琴川", "方兰生"], "望乡", 4],
  [ ["方兰生", "青玉司南佩"], "永相随", 4],
  [ ["百胜刀", "方兰生"], "无情客", 4],
  [ ["安陆", "红玉"], "明月青霜", 4],
  [ ["古剑红玉", "红玉"], "剑舞红袖", 4],
  [ ["天墉城", "红玉"], "千古剑灵", 4],
  [ ["紫榕林", "襄铃"], "故林栖", 4],
  [ ["风晴雪", "百里屠苏", "桃花谷"], "桃花幻梦", 10],
  [ ["风晴雪", "百里屠苏"], "与子成说", 3],
  [ ["百里屠苏", "悭臾"], "乘龙归", 3],
  [ ["百里屠苏", "天墉城"], "云涌昆仑", 3],
  [ ["天墉城", "陵越"], "天墉掌门", 4],
  [ ["百里屠苏", "陵越", "天墉城"], "天墉旧事", 10],
  [ ["百里屠苏", "古剑焚寂"], "焚焰血戮", 3],
  [ ["黑龙鳞片", "百里屠苏"], "故友赠礼", 3],
  [ ["百里屠苏", "欧阳少恭"], "琴心剑魄", 3],
  [ ["尹千觞", "欧阳少恭"], "醉梦江湖", 4],
  [ ["尹千觞", "幽都"], "幽都巫咸", 4],
  [ ["风晴雪", "尹千觞", "幽都"], "永夜苍茫", 10],
  [ ["风晴雪", "尹千觞"], "陌相逢", 4],
  [ ["风晴雪", "幽都"], "幽都灵女", 4],
  [ ["风晴雪", "方兰生", "百里屠苏", "红玉", "尹千觞", "襄铃"], "黑衣少侠传", 60]
]

PLAYERSPECIALS = [
  [214],
  [203, 200]
];

INITCARDNUMHAND = 10;
INITCARDNUMPOOL = 8;
//configurable settings
var AILEVEL = "巫炤";

class Trick {
  constructor(description) {
    this.description = description;
  }
  performTrick() {
    return this.description;
  }
}
class Character {
  constructor(id, name, score, season) {
    this.id = id;
    this.name = name;
    this.description = "img/" + id;
    this.score = score;
    this.season = season;
    this.owner = null;
  }
  isSpecial() {
    return false;
  }
  setOwner(owner) {
    this.owner = owner;
  }
  getID() {
    return this.id;
  }
  getName() {
    return this.name;
  }
  getSeason() {
    return this.season;
  }
  getScore() {
    return this.score;
  }
  getPortrait() {
    return "img/" + this.id + ".jpg";
  }
  getDesc() {
    var msg = this.id + "：" + this.getName() + "，" + this.getScore() + "分，" + this.getSeason() + "季, 归属玩家" + (this.owner == null ? "-" : this.owner.id) + "\n";
    return msg;
  }
}
class SpecialCharacter extends Character {
  constructor(id, name, description, score, season) {
    super(id, name, description, score, season);
    this.tricks = [];
  }
  addTrick(trick) {
    this.tricks.push(trick);
  }
  isSpecial() {
    return true;
  }
  performTricks() {
    var msg = "",
      tlen = this.tricks.length;
    for (var i = 0; i < tlen; i++)
      msg += "技能" + (i + 1) + "：" + this.tricks[i].performTrick() + "\n";
    return msg;
  }
  getDesc() {
    var msg = super.getDesc();
    msg += this.performTricks();
    return msg;
  }
}
class Deck {
  constructor() {
    this.characters = [];
  }
  addChar(char) {
    this.characters.unshift(char);
  }
  initDeck(size, repo) {
    for (var i = 0; i < size; i++)
      this.addChar(repo.removeRandom());
  }
  addRandom(repo) {
    if (repo.characters.length == 0) {
      log("Empty deck!!!!!!!!!!!!!!!!!");
      return null;
    }
    var char = repo.removeRandom();
    this.addChar(char);
    return char;
  }
  getMatch(char) {
    var s = char.getSeason();
    var len = this.characters.length;
    for (var i = 0; i < len; i++)
      if (this.characters[i].getSeason() == s)
        return this.characters[i];
    return null;
  }
  clear() {
    this.characters.length = 0;
  }
  getChars() {
    return this.characters;
  }
  removeRandom() {
    var i = Math.floor((Math.random() * this.characters.length));
    var char = this.characters[i];
    this.characters.splice(i, 1);
    return char;
  }
  removeChar(char) {
    var target = -1,
      clen = this.characters.length;
    for (var i = 0; i < clen; i++) {
      if (this.characters[i] == char) {
        target = i;
        break;
      }
    }
    if (target < 0) return false;
    this.characters.splice(target, 1);
    return true;
  }
  removeCharByID(id) {
    var target = -1,
      clen = this.characters.length;
    for (var i = 0; i < clen; i++) {
      if (this.characters[i].getID() == id) {
        target = i;
        break;
      }
    }
    if (target < 0) return false;
    var char = this.characters[target];
    this.characters.splice(target, 1);
    return char;
  }
  getChar(id) {
    var clen = this.characters.length;
    for (var i = 0; i < clen; i++)
      if (this.characters[i].getID() == id)
        return this.characters[i];
    return null;
  }
  getDesc() {
    var msg = "",
      clen = this.characters.length;
    for (var i = 0; i < clen; i++) {
      msg += this.characters[i].getDesc();
    }
    return msg;
  }

}
class Repository extends Deck {
  constructor(type) {
    super();
    if (type == "common")
      this.initCommonRepo();
    else if (type == "special")
      this.initSpecialRepo();
    else
      alert("Illegal Repository Type: " + type);
  }
  initCommonRepo() {
    var len = COMMONCHARLIST.length;
    for (var i = 0; i < len; i++) {
      let char = new Character(COMMONCHARLIST[i][0], COMMONCHARLIST[i][1], COMMONCHARLIST[i][2], COMMONCHARLIST[i][3]);
      this.addChar(char);
    }
    //let sx = new Character(1, "沈曦", 4, "春");
    //let lyc = new Character(2,"流月城", 4, "冬");
  }
  initSpecialRepo() {
    let sp = new SpecialCharacter(200, "沈夜", 6, "冬");
    let t1 = new Trick("打徒弟"),
      t2 = new Trick("打徒孙");
    sp.addTrick(t1);
    sp.addTrick(t2);
    this.addChar(sp);
    sp = new SpecialCharacter(203, "夏夷则", 6, "冬");
    t1 = new Trick("逸尘"), t2 = new Trick("小鱼干");
    sp.addTrick(t1);
    sp.addTrick(t2);
    this.addChar(sp);
    sp = new SpecialCharacter(214, "姬轩辕", 6, "秋");
    t1 = new Trick("失忆"), t2 = new Trick("做梦");
    sp.addTrick(t1);
    sp.addTrick(t2);
    this.addChar(sp);
  }
}
/*
    class Combo{
        constructor(name, score, characters){
            this.name = name;
            this.score = score;
            this.characters = characters;
        }
       getCharList(){return this.characters;}
    }
*/
class Player {
  constructor(id, commonRepo, specialRepo) {
    this.id = id;
    this.hand = new Deck();
    this.hand.initDeck(INITCARDNUMHAND, commonRepo);
    this.table = new Deck();
    this.specials = new Deck();
    this.score = 0;
    this.matchable = true;
    //this.specials.addRandom(1, specialRepo);
  }
  initSpecials(repo) {
    var slen = PLAYERSPECIALS[this.id].length;
    for (var i = 0; i < slen; i++) {
      this.specials.addChar(repo.removeCharacterByID(PLAYERSPECIALS[this.id][i]));
    }
  }
  addChar(char) {
    this.table.addChar(char);
    char.setOwner(this);
    this.score += char.score;
  }
  getHand() {
    return this.hand;
  }
  getScore(){
    return this.score;
  }
  getDesc() {
    var msg = "玩家" + this.id;
    msg += "\n手牌：\n" + this.hand.getDesc();
    msg += "桌面：\n" + this.table.getDesc();
    msg += "特殊牌：\n" + this.specials.getDesc();
    return msg;
  }
}
class Model {
  constructor() {
    this.commonRepository = new Repository("common");
    this.specialRepository = new Repository("special");
    this.player0 = new Player(0, this.commonRepository, this.specialRepository);
    this.player1 = new Player(1, this.commonRepository, this.specialRepository);
    this.pool = new Deck();
    this.pool.initDeck(INITCARDNUMPOOL, this.commonRepository);
    this.activeChar = null;
  }
  discardCard(player, char){
    if(char == null)
      char = player.hand.removeRandom();
    else
      player.hand.removeChar(char);
    this.pool.addChar(char);
    var newChar = player.hand.addRandom(this.commonRepository);
    log((player==this.player0?"AI":"你") +"抛弃「"+char.name+"」换取一只「"+newChar.name+"」");
    view.updateDiscard(player.id, char, newChar);
  }
  needRedeal(){
    return this.pool.getChars().length>=INITCARDNUMPOOL+2;
  }
  redeal(){
    var chars = this.commonRepository.characters;
    this.commonRepository.characters = chars.concat(this.pool.getChars());
    this.pool.clear();
    this.pool.initDeck(INITCARDNUMPOOL, this.commonRepository);
    view.getPool().updateRedeal();
  }
  handlePlayer1NoMatch(){
    if(this.player1.hand.characters.length == 0)
      blockGame();
    else if(!this.hasMatch(this.player1)){
      if(this.needRedeal()){
        setTimeout(function(){
          blockGame();
          model.redeal();
          model.handlePlayer1NoMatch();
          blockGame();
        }, OPERATIONDELAY*2);
        //this.redeal();
        //this.
      }
      else if(this.player1.matchable){
        this.player1.matchable = false;
        notifyNoMatch("show");
        view.getHand1().addDiscardController();
      }
    }
    else if(!this.player1.matchable){
      notifyNoMatch("hidden");
      this.player1.matchable = true;
      view.getHand1().removeDiscardController();
    }
  }
  hasMatch(player){
    var match = this.pickLeft(player);
    return match!=null;
  }
  dealOne(char) {
    if (char == null)
      var char = this.pool.addRandom(this.commonRepository);
    else
      this.pool.addChar(char);//log("发牌:"+char.getDesc());
    view.updateDeal(char);
  }
  pickLeft(player){
      var poolChars = this.pool.getChars();
      var hand = player.getHand();
      var poolChar = null;
      var handChar = null;
      for (var i = poolChars.length -1; i >= 0 ; i--) {
        handChar = hand.getMatch(poolChars[i]);
        if (handChar != null) {
          poolChar = poolChars[i];
          break;
        }
      }
      if (handChar != null)
        return [handChar, poolChar];
      return null;
  }
  aiPick() {
    //returns an array [hand pick, pool pick]
    switch (AILEVEL) {
      case "巫炤":
        return this.pickLeft(this.player0);
        break;
      default: log("Invalid AI　Level!!!!!!!!");
        return null;
    }
  }
  aiDiscard(){
    switch (AILEVEL) {
      case "巫炤":
        return null;
        break;
      default: log("Invalid AI　Level!!!!!!!!");
        return null;
    }
  }
  makeOpponentPick() {
    var pick = this.aiPick();
    if (pick == null) {
      if(this.needRedeal())
        this.redeal();
      else {
        var discard = this.aiDiscard();
        this.discardCard(this.player0, discard);
      }
      this.makeOpponentPick();
    }
    else
    this.pickCard(this.player0, pick[0], pick[1]);
  }
  pickCard(player, handChar, poolChar) {
    this.pool.removeChar(poolChar);
    player.hand.removeChar(handChar);
    player.addChar(poolChar);
    player.addChar(handChar);
    view.updatePickPoolCard(player.id, handChar.id, poolChar.id);
    log((player==this.player0?"AI用「":"你用「")+handChar.name +"」吸引到一只「"+ poolChar.name+"」");
    /*
    if(this.checkGameEnd()){
      this.player0.getScore
    }
    */
  }
  setHand1Active(char) {
    if (this.activeChar == null || this.activeChar != char) {
      view.updateHand1Active(this.activeChar, char);
      this.activeChar = char;
    } else {
      view.updateHand1Active(this.activeChar, null);
      this.activeChar = null;
    }
  }
  getActiveChar() {
    return this.activeChar;
  }
  getPlayer0() {
    return this.player0;
  }
  getPlayer1() {
    return this.player1;
  }
  getPool() {
    return this.pool;
  }
  getDesc() {
    var msg = this.player0.getDesc();
    msg += this.player1.getDesc();
    msg += "卡池\n" + this.pool.getDesc();
    return msg;
  }
}
